<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Study with Gandalf</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
:root {
  --bg: #0b0e1a;
  --card: #171b33;
  --accent: #7c83ff;
  --good: #4caf50;
  --mid: #ffb300;
  --bad: #e53935;
  --text: #eaeaf0;
}

body {
  margin: 0;
  background: radial-gradient(circle at top, #1a1f44, var(--bg));
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--text);
  display: flex;
  justify-content: center;
  min-height: 100vh;
}

#app {
  width: 390px;
  padding: 18px;
}

/* TRUST BAR */
#trustContainer {
  position: sticky;
  top: 0;
  z-index: 10;
  background: rgba(10,12,30,0.9);
  backdrop-filter: blur(6px);
  border-radius: 16px;
  padding: 10px;
  margin-bottom: 14px;
}

#trustLabel {
  font-size: 12px;
  opacity: 0.7;
  margin-bottom: 6px;
}

#trustBar {
  height: 16px;
  background: #222;
  border-radius: 12px;
  overflow: hidden;
}

#trustFill {
  height: 100%;
  width: 70%;
  background: linear-gradient(90deg, var(--bad), var(--mid), var(--good));
  animation: bubble 4s linear infinite;
  transition: width 0.4s;
}

@keyframes bubble {
  0% { filter: hue-rotate(0deg); }
  50% { filter: hue-rotate(20deg); }
  100% { filter: hue-rotate(0deg); }
}

/* GANDALF */
#gandalf {
  text-align: center;
  margin: 14px 0;
  position: relative;
}

#gandalfEmoji {
  font-size: 64px;
}

#face {
  font-size: 42px;
}

/* WORK MODE ANIMATION */
.working #gandalfEmoji {
  animation: float 3s ease-in-out infinite;
  transform-origin: center;
}

.working .card {
  filter: blur(3px) brightness(0.9);
}

@keyframes float {
  0% { transform: translateY(0); opacity: 0.8; }
  50% { transform: translateY(-10px); opacity: 1; }
  100% { transform: translateY(0); opacity: 0.8; }
}

/* CARD */
.card {
  background: var(--card);
  border-radius: 18px;
  padding: 16px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.45);
  transition: filter 0.4s;
}

#speech {
  min-height: 80px;
  line-height: 1.6;
}

/* CONTROLS */
#controls {
  margin-top: 14px;
}

input, button {
  width: 100%;
  padding: 10px;
  border-radius: 12px;
  border: none;
  margin-top: 8px;
  background: #0e1230;
  color: var(--text);
  font-size: 14px;
}

button {
  background: var(--accent);
  cursor: pointer;
}

button.secondary {
  background: #33396b;
}

button:hover { filter: brightness(1.1); }

#choices button { margin-top: 6px; }

#timer {
  text-align: center;
  font-size: 28px;
  margin-top: 12px;
}
</style>
</head>
<body>
<div id="app">

  <div id="trustContainer">
    <div id="trustLabel">Gandalf's Trust</div>
    <div id="trustBar"><div id="trustFill"></div></div>
  </div>

  <div id="gandalf">
    <div id="gandalfEmoji">üßô‚Äç‚ôÇÔ∏è</div>
    <div id="face">üôÇ</div>
  </div>

  <div class="card">
    <div id="speech"></div>

    <div id="controls">
      <input id="textInput" placeholder="Enter tasks separated by commas" />
      <div id="choices"></div>
      <button id="sendBtn">Confirm</button>
    </div>

    <div id="timer"></div>
  </div>
</div>

<script>
/***********************
 * STATE + STORAGE
 ***********************/
const KEY = "gandalfStudyState";
const today = new Date().toDateString();
let state = JSON.parse(localStorage.getItem(KEY)) || null;

if (!state || state.date !== today) {
  state = { date: today, trust: 70, tasks: [], mode: "init" };
  save();
}

function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

/***********************
 * UI HELPERS
 ***********************/
const speech = document.getElementById("speech");
const face = document.getElementById("face");
const trustFill = document.getElementById("trustFill");
const input = document.getElementById("textInput");
const choices = document.getElementById("choices");
const timerEl = document.getElementById("timer");

function speak(text, mood="üôÇ") {
  speech.innerText = text;
  face.innerText = mood;
}

function updateTrust(d){
  state.trust = Math.max(0, Math.min(100, state.trust + d));
  trustFill.style.width = state.trust + "%";
  save();
}

/***********************
 * TIMER
 ***********************/
let interval = null;
let endTime = null;

function startTimer(mins, onEnd) {
  clearInterval(interval);
  document.body.classList.add("working");
  endTime = Date.now() + mins * 60000;

  interval = setInterval(() => {
    const left = Math.max(0, endTime - Date.now());
    const m = Math.floor(left / 60000);
    const s = Math.floor((left % 60000) / 1000);
    timerEl.innerText = `${m}:${s.toString().padStart(2,"0")}`;
    if (left <= 0) {
      clearInterval(interval);
      document.body.classList.remove("working");
      timerEl.innerText = "";
      onEnd();
    }
  }, 1000);
}

/***********************
 * CONTROLS
 ***********************/
function showButtons(list) {
  choices.innerHTML = "";
  list.forEach(b => choices.appendChild(b));
}

function button(text, cls="", fn){
  const b = document.createElement("button");
  b.innerText = text;
  if (cls) b.classList.add(cls);
  b.onclick = fn;
  return b;
}

function showClock(min,max,step,cb){
  choices.innerHTML = "";
  const label = document.createElement("div");
  label.style.fontSize = "22px";
  const slider = document.createElement("input");
  slider.type = "range"; slider.min=min; slider.max=max; slider.step=step; slider.value=min;
  slider.oninput = ()=> label.innerText = slider.value+" minutes";
  label.innerText = slider.value+" minutes";
  showButtons([
    label,
    slider,
    button("Set Time","",()=>cb(parseInt(slider.value)))
  ]);
}

/***********************
 * LOGIC
 ***********************/
function render(){
  trustFill.style.width = state.trust+"%";
  input.style.display = "none";
  document.getElementById("sendBtn").style.display = "none";
  choices.innerHTML = "";

  if (state.mode === "init"){
    speak("A new day begins. Name your tasks.");
    input.style.display = "block";
    document.getElementById("sendBtn").style.display = "block";
    return;
  }

  if (state.mode === "idle"){
    speak("What will you do now?");
    showButtons([
      ...state.tasks.map(t => button(t,"",()=>{ state.mode="askStudy"; save(); render(); })),
      button("Take a break","secondary",()=>{
        if (state.trust < 30) speak("No. Work first.","üòê");
        else { state.mode="askBreak"; save(); render(); }
      })
    ]);
  }

  if (state.mode === "askStudy"){
    speak("Set your study time.","üßê");
    showClock(15,120,5,mins=>{
      speak("Focus. I am watching.","üëÅÔ∏è");
      state.mode="working"; save();
      startTimer(mins,()=>{
        speak("Well done.","üòÑ"); updateTrust(+10);
        state.mode="idle"; save(); render();
      });
    });
  }

  if (state.mode === "working"){
    showButtons([
      button("Emergency break","secondary",()=>{
        updateTrust(-15);
        speak("You broke focus.","üò†");
        clearInterval(interval);
        document.body.classList.remove("working");
        state.mode="askBreak"; save(); render();
      })
    ]);
  }

  if (state.mode === "askBreak"){
    speak("Set break duration.","üòê");
    showClock(5,30,5,mins=>{
      speak("Return on time.","üëÄ");
      state.mode="break"; save();
      startTimer(mins,()=>{
        speak("You lingered.","üò†"); updateTrust(-10);
        state.mode="idle"; save(); render();
      });
    });
  }
}

/***********************
 * EVENTS
 ***********************/
document.getElementById("sendBtn").onclick = ()=>{
  state.tasks = input.value.split(",").map(v=>v.trim());
  state.mode="idle"; save(); render();
};

render();
</script>
</body>
</html>
