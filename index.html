<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Gandalf Study Companion</title>
<style>
:root{
  --good:#4ade80;--mid:#facc15;--bad:#f87171;
}
body{margin:0;font-family:system-ui;background:#0f172a;color:#e5e7eb;}
header{padding:12px 20px;display:flex;align-items:center;gap:16px;}
#trustBar{flex:1;height:16px;border-radius:999px;background:#1e293b;overflow:hidden;}
#trustFill{height:100%;width:80%;background:var(--good);transition:width .4s,background .4s;}
main{display:flex;gap:16px;padding:20px;}
.card{background:#020617;border-radius:16px;padding:20px;flex:1;box-shadow:0 20px 40px rgba(0,0,0,.4);} 
#stats{width:260px;font-size:14px;opacity:.9;} 
.stat{display:flex;justify-content:space-between;margin:8px 0;} 
#gandalf{text-align:center;font-size:96px;transition:transform .4s;} 
.working #gandalf{transform:scale(1.3);} 
.working .card{filter:blur(6px) brightness(.7);} 
#timer{font-size:52px;text-align:center;margin:12px 0;filter:none!important;} 
button{background:#334155;border:none;color:white;padding:10px 14px;border-radius:10px;margin:6px;cursor:pointer;} 
button:hover{background:#475569;} 
@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-16px)}100%{transform:translateY(0)}} 
.working #gandalfEmoji{animation:float 3s ease-in-out infinite}
</style>
</head>
<body>
<header>
  <div id="trustBar"><div id="trustFill"></div></div>
  <span id="trustLabel">Trust: 80</span>
</header>
<main>
  <div class="card" id="app"></div>
  <div class="card" id="stats">
    <h3>Stats (Today)</h3>
    <div class="stat"><span>Study</span><span id="sStudy">0m</span></div>
    <div class="stat"><span>Break</span><span id="sBreak">0m</span></div>
    <div class="stat"><span>Idle</span><span id="sIdle">0m</span></div>
  </div>
</main>
<script>
/********************
 CORE STATE & STORAGE
*********************/
const DAY=()=>new Date().toDateString();
let state=JSON.parse(localStorage.getItem('gandalf'))||{
  day:DAY(),trust:80,mode:'idle',timerEnd:null,
  stats:{study:0,break:0,idle:0}
};
if(state.day!==DAY()){
  state={day:DAY(),trust:80,mode:'idle',timerEnd:null,stats:{study:0,break:0,idle:0}};
}
let interval=null;let lastTick=Date.now();

function save(){localStorage.setItem('gandalf',JSON.stringify(state));}

/********************
 TRUST & SPEECH
*********************/
function updateTrust(v){
  state.trust=Math.max(0,Math.min(100,state.trust+v));
  save();renderHeader();
}
function speak(text,emoji='ðŸ§™'){
  app.innerHTML=`<div id="gandalf"><div id="gandalfEmoji">${emoji}</div></div><p>${text}</p>`;
}

/********************
 TIMER & TICK LOGIC
*********************/
function tick(){
  const now=Date.now();
  const delta=(now-lastTick)/60000; // minutes
  lastTick=now;
  if(state.stats[state.mode]!=null){state.stats[state.mode]+=delta;}

  if(state.timerEnd && now>=state.timerEnd){
    clearInterval(interval);interval=null;
    document.body.classList.remove('working');
    state.timerEnd=null;
    if(state.mode==='study'){speak('Well done.','ðŸ˜„');updateTrust(+10);} 
    if(state.mode==='break'){speak('You lingered too long.','ðŸ˜ ');updateTrust(-10);} 
    state.mode='idle';save();render();
  }
  renderStats();save();
}

function startTimer(minutes){
  clearInterval(interval);
  state.timerEnd=Date.now()+minutes*60000;
  lastTick=Date.now();
  interval=setInterval(tick,1000);
  document.body.classList.add('working');
  save();
}

/********************
 UI RENDERING
*********************/
function renderHeader(){
  trustFill.style.width=state.trust+'%';
  trustFill.style.background=state.trust>60?'var(--good)':state.trust>30?'var(--mid)':'var(--bad)';
  trustLabel.textContent='Trust: '+state.trust;
}
function renderStats(){
  sStudy.textContent=Math.round(state.stats.study)+'m';
  sBreak.textContent=Math.round(state.stats.break)+'m';
  sIdle.textContent=Math.round(state.stats.idle)+'m';
}

function render(){
  renderHeader();
  if(state.timerEnd) return; // timer screen active

  speak('What will you do now?','ðŸ§™');
  app.innerHTML+=`<div>
    <button onclick="startStudy()">Study</button>
    <button onclick="startBreak()">Break</button>
  </div>`;
}

/********************
 ACTIONS
*********************/
function startStudy(){
  state.mode='study';
  speak('Study. I am watching.','ðŸ§™');
  startTimer(25);
}
function startBreak(){
  if(state.trust<30){speak('No. Earn it.','ðŸ˜ ');return;}
  state.mode='break';
  speak('Be quick.','ðŸ‘€');
  startTimer(5);
}

/********************
 INIT
*********************/
setInterval(tick,60000);
render();renderStats();
</script>
</body>
</html>
