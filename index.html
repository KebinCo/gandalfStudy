<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Study with Gandalf</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
:root {
  --bg: #0f1220;
  --card: #1b1f3b;
  --accent: #7c83ff;
  --good: #4caf50;
  --bad: #e53935;
  --text: #eaeaf0;
}

body {
  margin: 0;
  background: radial-gradient(circle at top, #1b1f3b, #0f1220);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--text);
  display: flex;
  justify-content: center;
  min-height: 100vh;
}

#app {
  width: 390px;
  padding: 18px;
}

/* TRUST BAR */
#trustContainer {
  background: #11142b;
  border-radius: 14px;
  padding: 8px;
  margin-bottom: 12px;
}

#trustLabel {
  font-size: 12px;
  opacity: 0.7;
  margin-bottom: 4px;
}

#trustBar {
  height: 14px;
  background: #333;
  border-radius: 10px;
  overflow: hidden;
}

#trustFill {
  height: 100%;
  width: 70%;
  background: linear-gradient(90deg, var(--bad), var(--good));
  transition: width 0.3s;
}

/* GANDALF */
#gandalf {
  text-align: center;
  margin: 14px 0;
}

#gandalfEmoji {
  font-size: 64px;
}

#face {
  font-size: 42px;
}

/* CARD */
.card {
  background: var(--card);
  border-radius: 16px;
  padding: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}

#speech {
  min-height: 80px;
  line-height: 1.5;
}

/* CONTROLS */
#controls {
  margin-top: 12px;
}

input, button, select {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: none;
  margin-top: 8px;
  background: #11142b;
  color: var(--text);
  font-size: 14px;
}

button {
  background: var(--accent);
  cursor: pointer;
}

button:hover {
  filter: brightness(1.1);
}

#choices button {
  margin-top: 6px;
}

#timer {
  text-align: center;
  font-size: 26px;
  margin-top: 10px;
}
</style>
</head>
<body>
<div id="app">

  <div id="trustContainer">
    <div id="trustLabel">Gandalf's Trust</div>
    <div id="trustBar"><div id="trustFill"></div></div>
  </div>

  <div id="gandalf">
    <div id="gandalfEmoji">üßô‚Äç‚ôÇÔ∏è</div>
    <div id="face">üôÇ</div>
  </div>

  <div class="card">
    <div id="speech"></div>

    <div id="controls">
      <input id="textInput" placeholder="Enter tasks separated by commas" />
      <div id="choices"></div>
      <button id="sendBtn">Confirm</button>
    </div>

    <div id="timer"></div>
  </div>
</div>

<script>
/***********************
 * PERSISTENCE
 ***********************/
const STORAGE_KEY = "gandalfStudyState";
const todayKey = new Date().toDateString();

let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || null;

if (!state || state.date !== todayKey) {
  state = {
    date: todayKey,
    trust: 70,
    tasks: [],
    mode: "init",
    currentTask: null
  };
  save();
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/***********************
 * TEXT BANK
 ***********************/
const lines = {
  greet: "A new day rises. Tell me your tasks.",
  idle: "What will you do now?",
  studyAskTime: "For how long will you study?",
  breakAskTime: "How long will you be gone?",
  workStart: "Very well. I shall keep watch.",
  breakOk: "Go, but return swiftly.",
  late: "You are late. This displeases me.",
  proud: "Well done. You honor your word.",
  refuse: "No. Earn your rest first."
};

/***********************
 * UI HELPERS
 ***********************/
const speech = document.getElementById("speech");
const face = document.getElementById("face");
const trustFill = document.getElementById("trustFill");
const input = document.getElementById("textInput");
const choices = document.getElementById("choices");
const timerEl = document.getElementById("timer");

function speak(text, mood="üôÇ") {
  speech.innerText = text;
  face.innerText = mood;
}

function updateTrust(delta) {
  state.trust = Math.max(0, Math.min(100, state.trust + delta));
  trustFill.style.width = state.trust + "%";
  save();
}

/***********************
 * TIMER (SAFE)
 ***********************/
let interval = null;

function startTimer(mins, onEnd) {
  clearInterval(interval);
  const end = Date.now() + mins * 60000;

  interval = setInterval(() => {
    const left = Math.max(0, end - Date.now());
    const m = Math.floor(left / 60000);
    const s = Math.floor((left % 60000) / 1000);
    timerEl.innerText = `${m}:${s.toString().padStart(2, "0")}`;

    if (left <= 0) {
      clearInterval(interval);
      timerEl.innerText = "";
      onEnd();
    }
  }, 1000);
}

/***********************
 * CHOICE BUTTONS
 ***********************/
function showChoices(list, callback) {
  choices.innerHTML = "";
  list.forEach(item => {
    const btn = document.createElement("button");
    btn.innerText = item;
    btn.onclick = () => callback(item);
    choices.appendChild(btn);
  });
}

/***********************
 * CORE LOGIC
 ***********************/
function render() {
  trustFill.style.width = state.trust + "%";
  input.style.display = "none";
  document.getElementById("sendBtn").style.display = "none";
  choices.innerHTML = "";

  if (state.mode === "init") {
    speak(lines.greet);
    input.style.display = "block";
    document.getElementById("sendBtn").style.display = "block";
    return;
  }

  if (state.mode === "idle") {
    speak(lines.idle);
    showChoices([...state.tasks, "Break"], choice => {
      if (choice === "Break") {
        if (state.trust < 30) {
          speak(lines.refuse, "üòê");
          return;
        }
        state.mode = "askBreak";
        render();
      } else {
        state.currentTask = choice;
        state.mode = "askStudy";
        render();
      }
    });
  }

  if (state.mode === "askStudy") {
    speak(lines.studyAskTime);
    showChoices(["25", "40", "60"], mins => {
      speak(lines.workStart, "üßê");
      state.mode = "working";
      save();
      startTimer(parseInt(mins), () => {
        speak(lines.proud, "üòÑ");
        updateTrust(+10);
        state.mode = "idle";
        save();
        render();
      });
    });
  }

  if (state.mode === "askBreak") {
    speak(lines.breakAskTime);
    showChoices(["5", "10", "15"], mins => {
      speak(lines.breakOk, "üòê");
      state.mode = "break";
      save();
      startTimer(parseInt(mins), () => {
        speak(lines.late, "üò†");
        updateTrust(-10);
        state.mode = "idle";
        save();
        render();
      });
    });
  }
}

/***********************
 * EVENTS
 ***********************/
document.getElementById("sendBtn").onclick = () => {
  const value = input.value.trim();
  if (!value) return;
  state.tasks = value.split(",").map(v => v.trim());
  state.mode = "idle";
  save();
  render();
};

render();
</script>
</body>
</html>
